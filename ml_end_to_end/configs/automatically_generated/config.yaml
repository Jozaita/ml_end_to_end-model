# Do not edit this file. It is automatically generated by ml_end_to_end/generate_final_config.py.
# If you want to modify configuration, edit source files in cybulde/configs directory.

defaults:
- override hydra/hydra_logging: disabled
- _self_
hydra:
  output_subdir: null
  run:
    dir: .

infrastructure:
  project_id: ageless-fire-423616-e1
  zone: europe-west1-b
  region: europe-west1
  instance_group_creator:
    _target_: ml_end_to_end.infrastructure.instance_group_creator.InstanceGroupCreator
    instance_template_creator:
      _target_: ml_end_to_end.infrastructure.instance_template_creator.InstanceTemplateCreator
      scopes:
      - https://www.googleapis.com/auth/cloud-platform
      - https://www.googleapis.com/auth/cloud.useraccounts.readonly
      - https://www.googleapis.com/auth/cloudruntimeconfig
      network: https://www.googleapis.com/compute/v1/projects/ageless-fire-423616-e1/global/networks/default
      subnetwork: https://www.googleapis.com/compute/v1/projects/ageless-fire-423616-e1/regions/europe-west1/subnetworks/default
      startup_script_path: scripts/vm_startup/task_runner_startup_script.sh
      vm_config:
        machine_type: n1-standard-2
        accelerator_count: 1
        accelerator_type: nvidia-tesla-t4
        vm_type: STANDARD
        disks: []
      boot_disk_config:
        project_id: deeplearning-platform-release
        name: common-cu113-v20230925
        size_gb: 50
        labels:
          project: ageless-fire-423616-e1
      vm_metadata_config:
        instance_group_name: test
        docker_image: europe-west1-docker.pkg.dev/ageless-fire-423616-e1/ml-end-to-end/ml-end-to-end-model:train--86140A2E-56E6-4F67-B724-7C294D8B0761
        zone: europe-west1-b
        python_hash_seed: 42
        mlflow_tracking_uri: http://mlflow-tracking-server-mlflow.europe-west1-b.c.ml-end-to-end.internal:6100
        node_count: 1
        disks: []
      template_name: test
      project_id: ageless-fire-423616-e1
      labels:
        project: ageless-fire-423616-e1
    name: test
    node_count: 1
    project_id: ageless-fire-423616-e1
    zone: europe-west1-b
    region: europe-west1
  mlflow:
    mlflow_external_tracking_uri: http://localhost:6100
    mlflow_internal_tracking_uri: http://mlflow-tracking-server-mlflow.europe-west1-b.c.ml-end-to-end.internal:6100
    experiment_name: Default
    run_name: null
    run_id: b2606c1ad046422390274ec1d89c7f21
    experiment_id: '0'
    experiment_url: http://localhost:6100/#/experiments/0/runs/b2606c1ad046422390274ec1d89c7f21
    artifact_uri: gs://mlflow-test-joc/0/b2606c1ad046422390274ec1d89c7f21/artifacts
save_last_checkpoint_every_n_train_steps: 500
seed: 1234
tasks:
  binary_text_classification_task:
    _target_: ml_end_to_end.training.tasks.tar_model_exporting_training_task.TarModelExportingTrainingTask
    name: binary_text_classification_task
    data_module:
      _target_: ml_end_to_end.data_modules.data_modules.TextClassificationDataModule
      batch_size: 64
      shuffle: false
      num_workers: 8
      pin_memory: true
      drop_last: true
      persistent_workers: false
      train_df_path: gs://ml_end_to_end/data/processed/rebalanced_split/train.parquet
      dev_df_path: gs://ml_end_to_end/data/processed/rebalanced_split/dev.parquet
      test_df_path: gs://ml_end_to_end/data/processed/rebalanced_split/test.parquet
      transformation:
        _target_: ml_end_to_end.models.transformations.HuggingFaceTokenizationTransformation
        pretrained_tokenizer_name_or_path: gs://ml_end_to_end/data/processed/rebalanced_split/trained_tokenizer
        max_sequence_length: 100
      text_column_name: cleaned_text
      label_column_name: label
    lightning_module:
      _target_: ml_end_to_end.training.lightning_modules.binary_text_classification.BinaryTextClassificationLightningModule
      model:
        _target_: ml_end_to_end.models.models.BinaryTextClassificationModel
        backbone:
          _target_: ml_end_to_end.models.backbones.HuggingFaceBackbone
          transformation:
            _target_: ml_end_to_end.models.transformations.HuggingFaceTokenizationTransformation
            pretrained_tokenizer_name_or_path: gs://ml_end_to_end/data/processed/rebalanced_split/trained_tokenizer
            max_sequence_length: 100
          pretrained_model_name_or_path: prajjwal1/bert-tiny
          pretrained: false
        adapter:
          _target_: ml_end_to_end.models.adapters.MLPWithPooling
          output_feature_sizes:
          - -1
          biases: null
          activation_fns: null
          dropouts_drop_probs: null
          batch_norms: null
          order: LABDN
          standardize_input: true
          pooling_method: null
          output_attribute_to_use: pooler_output
        head:
          _target_: ml_end_to_end.models.heads.SigmoidHead
          in_features: 128
          out_features: 1
      loss:
        _target_: ml_end_to_end.training.loss_functions.BCEWithLogitsLoss
        reduction: mean
      optimizer:
        _target_: torch.optim.AdamW
        _partial_: true
        lr: 0.005
        betas:
        - 0.9
        - 0.999
        eps: 1.0e-08
        weight_decay: 0.0
        amsgrad: false
        foreach: false
        maximize: false
        capturable: false
      scheduler:
        _target_: ml_end_to_end.training.schedulers.CommonLightingScheduler
        scheduler:
          _target_: torch.optim.lr_scheduler.ReduceLROnPlateau
          _partial_: true
          mode: max
          factor: 0.1
          patience: 10
          threshold: 0.0001
          threshold_mode: rel
          cooldown: 0
          min_lr: 0.0
          eps: 1.0e-08
          verbose: false
        interval: epoch
        frequency: 1
        monitor: val_f1_score
        strict: true
        name: null
    trainer:
      _target_: lightning.pytorch.trainer.trainer.Trainer
      accelerator: cpu
      strategy: ddp_find_unused_parameters_true
      devices: auto
      num_nodes: 1
      precision: bf16-mixed
      logger:
      - _target_: lightning.pytorch.loggers.mlflow.MLFlowLogger
        experiment_name: Default
        run_name: null
        tracking_uri: http://mlflow-tracking-server-mlflow.europe-west1-b.c.ml-end-to-end.internal:6100
        tags: null
        save_dir: null
        prefix: ''
        artifact_location: null
        run_id: b2606c1ad046422390274ec1d89c7f21
      callbacks:
      - _target_: lightning.pytorch.callbacks.ModelCheckpoint
        dirpath: gs://mlflow-test-joc/0/b2606c1ad046422390274ec1d89c7f21/artifacts/best-checkpoints/
        filename: null
        monitor: val_f1_score
        verbose: false
        save_last: true
        save_top_k: 2
        mode: max
        auto_insert_metric_name: false
        save_weights_only: false
        every_n_train_steps: null
        train_time_interval: null
        every_n_epochs: null
        save_on_train_epoch_end: null
      - _target_: lightning.pytorch.callbacks.ModelCheckpoint
        dirpath: gs://mlflow-test-joc/0/b2606c1ad046422390274ec1d89c7f21/artifacts/last-checkpoints/
        filename: checkpoint-{epoch}
        monitor: null
        verbose: false
        save_last: true
        save_top_k: -1
        mode: min
        auto_insert_metric_name: false
        save_weights_only: false
        every_n_train_steps: 500
        train_time_interval: null
        every_n_epochs: null
        save_on_train_epoch_end: null
      - _target_: lightning.pytorch.callbacks.LearningRateMonitor
        logging_interval: step
      fast_dev_run: false
      max_epochs: 1
      min_epochs: null
      max_steps: -1
      min_steps: null
      max_time: null
      limit_train_batches: 0.01
      limit_val_batches: 0.01
      limit_test_batches: 0.01
      limit_predict_batches: 1.0
      overfit_batches: 0.0
      val_check_interval: 1.0
      check_val_every_n_epoch: 1
      num_sanity_val_steps: 2
      log_every_n_steps: 1
      enable_checkpointing: true
      enable_progress_bar: true
      enable_model_summary: true
      accumulate_grad_batches: 1
      gradient_clip_val: 5.0
      gradient_clip_algorithm: value
      deterministic: null
      benchmark: null
      inference_mode: true
      use_distributed_sampler: true
      detect_anomaly: false
      barebones: false
      sync_batchnorm: true
      reload_dataloaders_every_n_epochs: 0
      default_root_dir: ./data/pytorch-lightning
    best_training_checkpoint: gs://mlflow-test-joc/0/b2606c1ad046422390274ec1d89c7f21/artifacts/best-checkpoints/last.ckpt
    last_training_checkpoint: gs://mlflow-test-joc/0/b2606c1ad046422390274ec1d89c7f21/artifacts/last-checkpoints/last.ckpt
    tar_model_export_path: gs://mlflow-test-joc/0/b2606c1ad046422390274ec1d89c7f21/artifacts/exported_model.tar.gz
  binary_text_evaluation_task:
    _target_: ml_end_to_end.evaluation.tasks.common_evaluation_task.CommonEvaluationTask
    name: binary_text_evaluation_task
    data_module:
      _target_: ml_end_to_end.data_modules.data_modules.TextClassificationDataModule
      batch_size: 64
      shuffle: false
      num_workers: 8
      pin_memory: true
      drop_last: true
      persistent_workers: false
      train_df_path: gs://ml_end_to_end/data/processed/rebalanced_split/train.parquet
      dev_df_path: gs://ml_end_to_end/data/processed/rebalanced_split/dev.parquet
      test_df_path: gs://ml_end_to_end/data/processed/rebalanced_split/test.parquet
      transformation:
        _target_: ml_end_to_end.models.transformations.HuggingFaceTokenizationTransformation
        pretrained_tokenizer_name_or_path: gs://ml_end_to_end/data/processed/rebalanced_split/trained_tokenizer
        max_sequence_length: 100
      text_column_name: cleaned_text
      label_column_name: label
    lightning_module:
      _target_: ml_end_to_end.evaluation.lightning_modules.binary_text_evaluation.BinaryTextEvaluationLightningModule
      _partial_: true
    trainer:
      _target_: lightning.pytorch.trainer.trainer.Trainer
      accelerator: cpu
      strategy: ddp_find_unused_parameters_true
      devices: auto
      num_nodes: 1
      precision: bf16-mixed
      logger:
      - _target_: lightning.pytorch.loggers.mlflow.MLFlowLogger
        experiment_name: Default
        run_name: null
        tracking_uri: http://mlflow-tracking-server-mlflow.europe-west1-b.c.ml-end-to-end.internal:6100
        tags: null
        save_dir: null
        prefix: ''
        artifact_location: null
        run_id: b2606c1ad046422390274ec1d89c7f21
      callbacks:
      - _target_: lightning.pytorch.callbacks.ModelCheckpoint
        dirpath: gs://mlflow-test-joc/0/b2606c1ad046422390274ec1d89c7f21/artifacts/best-checkpoints/
        filename: null
        monitor: val_f1_score
        verbose: false
        save_last: true
        save_top_k: 2
        mode: max
        auto_insert_metric_name: false
        save_weights_only: false
        every_n_train_steps: null
        train_time_interval: null
        every_n_epochs: null
        save_on_train_epoch_end: null
      - _target_: lightning.pytorch.callbacks.ModelCheckpoint
        dirpath: gs://mlflow-test-joc/0/b2606c1ad046422390274ec1d89c7f21/artifacts/last-checkpoints/
        filename: checkpoint-{epoch}
        monitor: null
        verbose: false
        save_last: true
        save_top_k: -1
        mode: min
        auto_insert_metric_name: false
        save_weights_only: false
        every_n_train_steps: 500
        train_time_interval: null
        every_n_epochs: null
        save_on_train_epoch_end: null
      - _target_: lightning.pytorch.callbacks.LearningRateMonitor
        logging_interval: step
      fast_dev_run: false
      max_epochs: 1
      min_epochs: null
      max_steps: -1
      min_steps: null
      max_time: null
      limit_train_batches: 0.01
      limit_val_batches: 0.01
      limit_test_batches: 0.01
      limit_predict_batches: 1.0
      overfit_batches: 0.0
      val_check_interval: 1.0
      check_val_every_n_epoch: 1
      num_sanity_val_steps: 2
      log_every_n_steps: 1
      enable_checkpointing: true
      enable_progress_bar: true
      enable_model_summary: true
      accumulate_grad_batches: 1
      gradient_clip_val: 5.0
      gradient_clip_algorithm: value
      deterministic: null
      benchmark: null
      inference_mode: true
      use_distributed_sampler: true
      detect_anomaly: false
      barebones: false
      sync_batchnorm: true
      reload_dataloaders_every_n_epochs: 0
      default_root_dir: ./data/pytorch-lightning
    tar_model_path: gs://mlflow-test-joc/0/b2606c1ad046422390274ec1d89c7f21/artifacts/exported_model.tar.gz
model_selector:
  _target_: ml_end_to_end.evaluation.model_selector.ModelSelector
  mlflow_run_id: b2606c1ad046422390274ec1d89c7f21
  must_be_better_metric_comparers:
    f1_score:
      _target_: ml_end_to_end.evaluation.model_selector.MetricComparer
      bigger_is_better: true
      can_be_equal: false
      metric_name: test_f1_score
      threshold: 0.0
    model_size:
      _target_: ml_end_to_end.evaluation.model_selector.MetricComparer
      bigger_is_better: false
      can_be_equal: true
      metric_name: model_size
      threshold: 0.0
  to_be_thresholded_metric_comparers: {}
  threshold: 0.0
registered_model_name: bert_tiny
